CBLOCK 0X20
GUARDAR_DATO
COMANDO
DATA_GUARDAR
DATAS
CUENTA
DATO
ENDC
    
#DEFINE	    RS	    PORTC,0
#DEFINE	    E	    PORTC,1
;#DEFINE	    RW	    PORTC,2

LCD_INIT
    BSF	    STATUS,RP0
    CLRF    TRISD; SALIDA
    CLRF    TRISC; SALIDA
    BCF	    STATUS,RP0
    CALL    Retardo_1ms
    BCF	    RS; COMANDO
    MOVLW   0X30; RD4 RD5 RD6 RD7 -> RD3 AL RD0 
    CALL    LCD_CONFIG
    CALL    Retardo_1ms
    MOVLW   0X30
    CALL    LCD_CONFIG
    CALL    Retardo_1ms
    MOVLW   0X30
    CALL    LCD_CONFIG
    CALL    Retardo_1ms
    MOVLW   0X20; 4 BITS
    CALL    LCD_CONFIG
    CALL    LCD_2LINEAS; 0X28
    CALL    LCD_DISPLAY; 0X0C
    CALL    LCD_BORRAR; 0X01
    CALL    LCD_INCR	;0X06
    RETURN
LCD_LINEA2
    ADDLW   0XC0
    GOTO    LCD_COMANDO
LCD_LINEA1
    ADDLW   0X80; 0X80 + 1 = 0X81
    GOTO    LCD_COMANDO
LCD_DISPLAY
    MOVLW   0X0C
    GOTO    LCD_COMANDO
LCD_BORRAR
    MOVLW   0X01
    GOTO    LCD_COMANDO
LCD_INCR
    MOVLW   0X06
    GOTO    LCD_COMANDO
LCD_2LINEAS
    MOVLW   0X28
    GOTO    LCD_COMANDO
LCD_COMANDO
    MOVWF   COMANDO; 0X28
    MOVF    COMANDO,W
    CALL    LCD_CONFIG
    SWAPF   COMANDO,F; 0X28 -> 0X82
    MOVF    COMANDO,W
    CALL    LCD_CONFIG
    RETURN
LCD_CARACTER
    ;W = H 
    MOVWF   DATA_GUARDAR
    BSF	    RS; CARACTER
    CALL    LCD_DATOS
    SWAPF   DATA_GUARDAR,F
    MOVF    DATA_GUARDAR,W
    CALL    LCD_DATOS
    RETURN
LCD_DATOS
    ANDLW   B'11110000'
    MOVWF   DATAS
    BSF	    RS;MODO CARACTER
    MOVF    PORTD,W
    ANDLW   B'00001111'
    IORWF   DATAS
    MOVF    DATAS,W
    MOVWF   PORTD
    CALL    ENABLE
    RETURN
LCD_CONFIG
    ;W = 0X30
    ANDLW   B'11110000';
    ;	      00110000
    ; W=      00110000
    MOVWF   GUARDAR_DATO
    BCF	    RS; MODO COMANDO
    MOVF    PORTD,W
    ANDLW   B'00001111'
    ;         XXXX0101
    ;     W = 00000101
    IORWF   GUARDAR_DATO
    ; 00110000 OR 00000101 = 00110101
    MOVF    GUARDAR_DATO,W
    MOVWF   PORTD
    CALL    ENABLE
    RETURN
ENABLE
    CALL    Retardo_1ms
    CALL    Retardo_1ms
    BSF	    E
    CALL    Retardo_1ms
    BCF	    E
    RETURN
    
    
Retardo_1ms
  MOVLW	    .250
  MOVWF	    CUENTA
BUCLE
  NOP
  DECFSZ    CUENTA,F
  GOTO	    BUCLE
  MOVF	    DATO,W
  RETURN